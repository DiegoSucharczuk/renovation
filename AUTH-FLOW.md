# מערכת ההתחברות והרשאות - הסבר מלא

## 🔐 איך עובדת ההתחברות?

### שתי דרכי התחברות:

#### 1️⃣ **אימייל וסיסמה** (מסורתי)
```
משתמש → הרשמה (אימייל + סיסמה + שם) → Firebase Authentication → נוצר חשבון
```
- **הרשמה**: צריך אימייל, סיסמה ושם
- **כניסה**: אימייל + סיסמה
- **סיסמה נשמרת**: ב-Firebase (מוצפנת)

#### 2️⃣ **התחברות גוגל** (OAuth)
```
משתמש → לחיצה על "כניסה עם גוגל" → אישור חשבון גוגל → Firebase Authentication → נוצר חשבון
```
- **אין צורך בהרשמה**: אם יש חשבון גוגל, מספיק
- **אין צורך לזכור סיסמה**: גוגל מנהל את זה
- **מהיר ונוח**: קליק אחד

### ⚠️ **האם צריך סיסמה?**

**כן, אבל זה תלוי באיך נכנסים:**

| דרך כניסה | סיסמה נדרשת? | איפה הסיסמה? |
|-----------|--------------|---------------|
| אימייל/סיסמה | ✅ כן | Firebase Auth (מוצפנת) |
| גוגל | ❌ לא | נמצאת בגוגל, לא אצלנו |

**דוגמה:**
- אם נרשמת עם `user@gmail.com` + סיסמה → **צריך סיסמה** בכל כניסה
- אם נכנסת עם גוגל → **לא צריך סיסמה**, רק אישור גוגל

---

## 👥 הוספת משתמשים לפרויקט

### תהליך הוספת משתמש:

```
1. בעלים/מנהל נכנס להגדרות פרויקט
2. לוחץ "הוסף משתמש"
3. מזין אימייל של משתמש קיים במערכת
4. בוחר תפקיד (ADMIN, FAMILY, CONTRACTOR וכו')
5. המשתמש מתווסף לטבלת projectUsers
```

### ⚠️ **חשוב מאוד להבין:**

**המשתמש חייב להירשם קודם למערכת!**

```
❌ לא יעבוד:
1. מנסה להוסיף user@example.com
2. המייל לא קיים במערכת
3. שגיאה: "משתמש עם אימייל זה לא נמצא במערכת"

✅ יעבוד:
1. user@example.com נרשם קודם (דרך signup או גוגל)
2. עכשיו אפשר להוסיף אותו לפרויקט
3. הוא יראה את הפרויקט ברשימת הפרויקטים שלו
```

### הקוד שבודק את זה:

```typescript
// src/app/dashboard/[projectId]/settings/page.tsx

const handleAddMember = async () => {
  // חיפוש משתמש לפי אימייל
  const usersQuery = query(
    collection(db, 'users'),
    where('email', '==', userEmail.toLowerCase())
  );
  const usersSnapshot = await getDocs(usersQuery);

  if (usersSnapshot.empty) {
    setError('משתמש עם אימייל זה לא נמצא במערכת'); // ❌ לא קיים
    return;
  }

  // המשתמש קיים - אפשר להוסיף אותו
  const userId = usersSnapshot.docs[0].id;
  
  // יצירת רשומה בטבלת projectUsers
  await addDoc(collection(db, 'projectUsers'), {
    projectId,
    userId,
    roleInProject: selectedRole,
  });
}
```

---

## 🏗️ יצירת פרויקט

### מי יכול ליצור פרויקט?

**כל משתמש רשום!** (לא משנה איך נרשם - אימייל או גוגל)

### תהליך:

```
1. משתמש נרשם/נכנס למערכת
2. נכנס לדף "הפרויקטים שלי" (/projects)
3. לוחץ "צור פרויקט חדש"
4. ממלא:
   - שם פרויקט
   - כתובת
   - תקציב מתוכנן ← זה התקציב ההתחלתי! 💰
   - אחוז חריגה מותר
5. הפרויקט נוצר, והמשתמש הופך ל-OWNER
```

### ⚠️ **לתשומת לב:**

**כרגע דף יצירת הפרויקט עדיין לא מיושם במלואו.**

הקוד הקיים ב-`/projects` מציג רשימת פרויקטים קיימים, אבל **צריך להוסיף**:
- כפתור "צור פרויקט חדש" 
- דיאלוג/דף עם טופס יצירה
- שמירה ל-Firestore עם המשתמש הנוכחי כ-OWNER

**דוגמת קוד ליצירת פרויקט:**

```typescript
// כפתור בדף projects/page.tsx
<Button 
  variant="contained" 
  startIcon={<AddIcon />}
  onClick={() => setOpenCreateDialog(true)}
>
  צור פרויקט חדש
</Button>

// הפונקציה שיוצרת
const handleCreateProject = async () => {
  const newProject = await addDoc(collection(db, 'projects'), {
    name: projectName,
    address: projectAddress,
    budgetPlanned: Number(budgetPlanned),
    budgetAllowedOverflowPercent: 10,
    ownerId: user!.id, // ← המשתמש הנוכחי הופך לבעלים
    createdAt: new Date(),
  });
  
  // ניווט לפרויקט החדש
  router.push(`/dashboard/${newProject.id}`);
};
```

---

## 💰 התקציב - מאיפה זה בא?

### **תקציב מתוכנן (budgetPlanned)**

**מקור:** נקבע בזמן יצירת הפרויקט או בהגדרות

**איפה ממלאים:**

1️⃣ **ביצירת פרויקט חדש:**
```typescript
// בדף יצירת פרויקט (צריך ליצור אותו)
await addDoc(collection(db, 'projects'), {
  name: 'שיפוץ דירה',
  address: 'רחוב הרצל 1, תל אביב',
  budgetPlanned: 500000, // ← כאן מזינים את התקציב!
  budgetAllowedOverflowPercent: 10,
  ownerId: currentUser.uid,
  createdAt: new Date(),
});
```

2️⃣ **בעדכון פרויקט (בהגדרות):**
```typescript
// src/app/dashboard/[projectId]/settings/page.tsx
// כפתור "ערוך" → שינוי התקציב
await updateDoc(doc(db, 'projects', projectId), {
  budgetPlanned: 600000, // ← ניתן לשנות!
});
```

### איך התקציב משמש?

- **מוצג ב-Dashboard** (אם יש הרשאה)
- **משווים אליו את סך התשלומים**
- **מחשבים יתרה**: `יתרה = תקציב מתוכנן - סך ששולם`
- **מזהירים על חריגה**: אם עברנו את התקציב + אחוז חריגה

---

## 🔒 אבטחה - מה קורה אם מישהו אחר נכנס עם אותו אימייל?

### האבטחה של Firebase:

Firebase Authentication מונע כניסה לא מורשית:

#### תרחיש 1: **אותו אימייל, אותה דרך כניסה**

```
✅ אפשרי רק עם הסיסמה/אישור גוגל הנכון

דוגמה:
1. נרשמת עם user@example.com + סיסמה "123456"
2. מישהו אחר מנסה להיכנס עם user@example.com
3. צריך את הסיסמה "123456" ← רק אתה יודע אותה!
4. אם אין לו את הסיסמה → ❌ לא ייכנס
```

#### תרחיש 2: **אותו אימייל, דרכי כניסה שונות**

```
❌ אי אפשר! Firebase מזהה אימייל ייחודי

דוגמה:
1. נרשמת עם user@gmail.com דרך אימייל/סיסמה
2. מישהו מנסה להיכנס עם user@gmail.com דרך גוגל
3. Firebase רואה שהאימייל כבר קיים בשיטה אחרת
4. ❌ שגיאה: "האימייל כבר קיים"

פתרון: Firebase מאפשר לקשר חשבונות (Link Accounts)
```

### מה אם שכחתי סיסמה?

Firebase מספק **איפוס סיסמה** (צריך ליישם):

```typescript
import { sendPasswordResetEmail } from 'firebase/auth';

// שליחת מייל לאיפוס סיסמה
await sendPasswordResetEmail(auth, 'user@example.com');
```

---

## 📊 מבנה המערכת

### 3 טבלאות ב-Firestore:

#### 1. **users** (משתמשים)
```javascript
users/{userId}
  ├─ name: "ישראל ישראלי"
  ├─ email: "israel@example.com"
  └─ createdAt: Date
```
- **נוצר**: בהרשמה (אימייל או גוגל)
- **מטרה**: פרטי משתמש בסיסיים

#### 2. **projects** (פרויקטים)
```javascript
projects/{projectId}
  ├─ name: "שיפוץ דירה"
  ├─ address: "רחוב הרצל 1"
  ├─ budgetPlanned: 500000 ← התקציב!
  ├─ budgetAllowedOverflowPercent: 10
  ├─ ownerId: "user123" ← הבעלים
  └─ createdAt: Date
```
- **נוצר**: כשמישהו יוצר פרויקט
- **ownerId**: מקבל אוטומטית הרשאות OWNER

#### 3. **projectUsers** (קישור משתמשים לפרויקטים)
```javascript
projectUsers/{membershipId}
  ├─ projectId: "project123"
  ├─ userId: "user456"
  └─ roleInProject: "ADMIN" / "FAMILY" / "CONTRACTOR" וכו'
```
- **נוצר**: כשמוסיפים משתמש לפרויקט
- **מטרה**: ניהול הרשאות

---

## 🔄 זרימה מלאה של משתמש חדש

### תרחיש: קבלן רוצה לראות פרויקט

```
שלב 1: הרשמה
├─ הקבלן נרשם דרך אימייל/סיסמה או גוגל
├─ נוצר רשומה ב-users
└─ יש לו חשבון, אבל אין פרויקטים

שלב 2: הוספה לפרויקט
├─ בעלים נכנס להגדרות → "הוסף משתמש"
├─ מזין את האימייל של הקבלן
├─ בוחר תפקיד: CONTRACTOR
└─ נוצר רשומה ב-projectUsers

שלב 3: כניסה של הקבלן
├─ הקבלן נכנס עם האימייל והסיסמה שלו
├─ המערכת מוצאת את הפרויקטים שלו ב-projectUsers
├─ רואה שיש לו הרשאה CONTRACTOR
└─ יכול לצפות במשימות, אבל לא בתקציב!

שלב 4: ניסיון גישה לא מורשה
├─ הקבלן מנסה לגשת לדף תשלומים
├─ useProjectRole בודק: permissions.canViewPayments = false
└─ מוצג: "אין לך הרשאה לצפות בדף זה" ❌
```

---

## 🎯 סיכום

| שאלה | תשובה |
|------|--------|
| **למה גוגל טוב?** | נוח, מהיר, אין צורך לזכור סיסמה נוספת |
| **רק להתחלה?** | לא! אפשר להשתמש בכל שלב - הרשמה או כניסה |
| **מאיפה התקציב?** | ממלאים ביצירת פרויקט או עורכים בהגדרות |
| **רק מזין אימייל?** | כן! אבל המשתמש חייב להירשם קודם למערכת |
| **מישהו אחר עם אותו אימייל?** | לא יכול להיכנס ללא סיסמה/אישור גוגל נכון |
| **צריך סיסמה?** | אם נרשמת עם אימייל - כן. עם גוגל - לא |

---

## 🚨 חשוב לזכור!

1. ✅ **כל משתמש מוסף חייב להירשם קודם למערכת**
2. 🔒 **Firebase מטפל באבטחה** - אי אפשר להיכנס ללא אימות
3. 💰 **התקציב נקבע ביצירת פרויקט** וניתן לעדכון
4. 👥 **רק OWNER/ADMIN יכולים להוסיף משתמשים**
5. 🔑 **אימייל = זהות ייחודית** - לא יכולים 2 משתמשים עם אותו אימייל

---

**נוצר עם ❤️ לבהירות ואבטחה**
